### 问题
背景: 一台机器部署多个java服务，每个java服务都分别占用一个大于20000的端口  
在服务部署时，偶尔就会出现端口被占用问题，  
查看结果，一般都是被其它服务用来与mongodb服务连接使用了  

### 解决办法
##### 解决思路:   
因为连接mongodb时，机器会使用一个随机端口号  
通过查看某一服务占用端口情况，发现与mongodb有大量的连接，同时使用的端口号范围从10000到60000都有。  
linux默认随机范围是：32768 ~ 65535  
显然机器的默认范围修改过, 通过命令查看当前设置范围: ```cat /etc/sysctl.conf | grep ip_local_port_range```  
通过命令发现当前范围为: 10000 65000  
这就是问题的关键，原本分配给服务使用的端口，很可能会被随机端口占用  
因此：需要根据实际机器需要使用的随机端口数来设置ip_local_port_range值。同时，服务本身占用的端口不要在此范围内即可  

> 设置机器随机端口范围，修改文件/etc/sysctl.conf：  
> ```net.ipv4.ip_local_port_range = 30000 65535```  
> 使用配置生效：  
> ```sysctl -p /etc/sysctl.conf```  


##### 另外:
因为通过上面修改随机端口范围解决这个问题，可能导致一个新问题，就是随机端口不够用  
如果确实有这种情况出现的话，可以不使用上面的方式修改，而是通过设置保留端口解决,  
即在随机端口范围中排除个别端口，不允许随机时占用  

###### 命令行一次执行，只当时生效:
```
sysctl -w net.ipv4.ip_local_reserved_ports="8080,8081,8084"
```
###### 修改文件，永久生效: /etc/sysctl.conf：  
```
net.ipv4.ip_local_reserved_ports = "8080,8081,8084"
```
```
sysctl -p /etc/sysctl.conf
```
